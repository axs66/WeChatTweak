name: WeChatTweak CI

on: 
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 15
    env:
      THEOS: /opt/theos
      SDKVERSION: 16.4

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Theos
      run: |
        git clone --filter=blob:none https://github.com/theos/theos.git $THEOS
        sudo $THEOS/bin/update-theos

    - name: Build package
      run: |
        export PATH="$THEOS/bin:$PATH"
        make clean
        make package \
          THEOS_PACKAGE_SCHEME=rootless \
          DEBUG=0 \
          CODESIGNING_ALLOWED=NO

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: WeChatTweak_${{ github.run_number }}
        path: |
          packages/*.deb
          .theos/build/*.dylib
        compression-level: 9
        overwrite: true
