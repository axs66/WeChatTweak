name: WeChatTweak CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 20
    env:
      THEOS: ${{ github.workspace }}/theos  # 关键修改点
      SDKVERSION: 16.4

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Theos
      run: |
        mkdir -p $THEOS
        git clone --filter=blob:none --depth 1 \
          https://github.com/theos/theos.git $THEOS
        $THEOS/bin/update-theos

    - name: Build package
      run: |
        export PATH="$THEOS/bin:$PATH"
        make clean
        make package \
          THEOS_PACKAGE_SCHEME=rootless \
          DEBUG=0 \
          CODESIGNING_ALLOWED=NO

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: WeChatTweak_${{ github.run_number }}
        path: packages/*.deb
